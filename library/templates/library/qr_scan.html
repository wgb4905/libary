{% extends 'library/base.html' %}

{% block title %}二维码扫描 - {{ book.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-qrcode"></i> 二维码扫描结果
                    </h3>
                </div>
                
                <div class="card-body">
                    <!-- 图书信息 -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            {% if book.cover_image %}
                                <img src="{{ book.cover_image.url }}" class="img-fluid rounded" alt="{{ book.title }}">
                            {% else %}
                                <div class="text-center py-4 bg-light rounded">
                                    <i class="fas fa-book fa-3x text-muted"></i>
                                    <p class="mt-2">暂无封面</p>
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-8">
                            <h2 class="mb-2">{{ book.title }}</h2>
                            <p class="text-muted mb-3">
                                <i class="fas fa-user-edit"></i> {{ book.author }}
                            </p>
                            <p class="mb-3">{{ book.description|truncatechars:200 }}</p>
                            
                            <!-- 借阅状态 -->
                            <div class="alert {% if book_copy.is_available %}alert-success{% else %}alert-warning{% endif %}">
                                <h5 class="alert-heading">
                                    <i class="fas {% if book_copy.is_available %}fa-check-circle{% else %}fa-exclamation-triangle{% endif %}"></i>
                                    {% if book_copy.is_available %}
                                        可借阅
                                    {% else %}
                                        已借出
                                    {% endif %}
                                </h5>
                                {% if not book_copy.is_available %}
                                    <p class="mb-1">
                                        <strong>借阅者：</strong>{{ book_copy.borrower.username }}
                                    </p>
                                    <p class="mb-1">
                                        <strong>应还日期：</strong>{{ book_copy.due_date|date:"Y年m月d日" }}
                                    </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="text-center">
                        {% if book_copy.is_available %}
                            <!-- 借阅按钮 -->
                            <button id="borrowBtn" class="btn btn-success btn-lg" 
                                    data-bookcopy-id="{{ book_copy.id }}">
                                <i class="fas fa-book-reader"></i> 借阅此书
                            </button>
                            <div id="daysSelection" class="mt-3" style="display:none;">
                                <label for="daysInput" class="form-label">借阅天数：</label>
                                <div class="input-group mb-3" style="max-width: 300px; margin: 0 auto;">
                                    <input type="number" id="daysInput" class="form-control" 
                                           value="7" min="1" max="30">
                                    <span class="input-group-text">天</span>
                                    <button id="confirmBorrowBtn" class="btn btn-primary">
                                        确认借阅
                                    </button>
                                </div>
                            </div>
                        {% else %}
                            <!-- 归还按钮 -->
                            {% if user.is_authenticated and book_copy.borrower == user %}
                                <button id="returnBtn" class="btn btn-warning btn-lg" 
                                        data-bookcopy-id="{{ book_copy.id }}">
                                    <i class="fas fa-undo-alt"></i> 归还此书
                                </button>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    此书已被其他用户借阅，您无法归还。
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                    
                    <!-- 操作结果提示 -->
                    <div id="resultMessage" class="mt-4" style="display:none;"></div>
                    
                    <!-- 导航链接 -->
                    <div class="mt-4 pt-3 border-top text-center">
                        <a href="{% url 'book_detail' book.id %}" class="btn btn-outline-primary">
                            <i class="fas fa-info-circle"></i> 查看图书详情
                        </a>
                        <a href="{% url 'book_list' %}" class="btn btn-outline-secondary ms-2">
                            <i class="fas fa-list"></i> 返回图书列表
                        </a>
                        {% if user.is_authenticated %}
                            <a href="{% url 'my_borrowings' %}" class="btn btn-outline-info ms-2">
                                <i class="fas fa-bookmark"></i> 我的借阅
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- 二维码信息 -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-qrcode"></i> 二维码信息
                    </h5>
                </div>
                <div class="card-body text-center">
                    {% if book_copy.qr_code %}
                        <img src="{{ book_copy.qr_code.url }}" class="img-thumbnail mb-3" 
                             style="max-width: 200px;" alt="图书二维码">
                        <p class="text-muted mb-0">
                            扫描此二维码可快速访问此页面
                        </p>
                        <p class="text-muted small">
                            副本ID: {{ book_copy.id }} | 图书ID: {{ book.id }}
                        </p>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            此图书副本尚未生成二维码
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript代码 -->
<script>
$(document).ready(function() {
    // 借阅按钮点击事件
    $('#borrowBtn').click(function() {
        $('#daysSelection').show();
        $(this).hide();
    });
    
    // 确认借阅
    $('#confirmBorrowBtn').click(function() {
        var bookcopyId = $('#borrowBtn').data('bookcopy-id');
        var days = $('#daysInput').val();
        
        $.ajax({
            url: '/scan/' + bookcopyId + '/',
            type: 'POST',
            data: {
                'days': days,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    $('#resultMessage').html(`
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <strong>成功！</strong> ${response.message}<br>
                            应还日期：${response.due_date}
                        </div>
                    `).show();
                    $('#daysSelection').hide();
                    location.reload(); // 刷新页面更新状态
                } else {
                    if (response.redirect_url) {
                        window.location.href = response.redirect_url;
                    } else {
                        $('#resultMessage').html(`
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle"></i>
                                <strong>错误：</strong> ${response.error}
                            </div>
                        `).show();
                    }
                }
            },
            error: function() {
                $('#resultMessage').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>错误：</strong> 网络请求失败，请重试
                    </div>
                `).show();
            }
        });
    });
    
    // 归还按钮点击事件
    $('#returnBtn').click(function() {
        var bookcopyId = $(this).data('bookcopy-id');
        
        if (!confirm('确定要归还这本书吗？')) {
            return;
        }
        
        $.ajax({
            url: '/scan/' + bookcopyId + '/',
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    $('#resultMessage').html(`
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <strong>成功！</strong> ${response.message}
                        </div>
                    `).show();
                    location.reload(); // 刷新页面更新状态
                } else {
                    $('#resultMessage').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i>
                            <strong>错误：</strong> ${response.error}
                        </div>
                    `).show();
                }
            },
            error: function() {
                $('#resultMessage').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>错误：</strong> 网络请求失败，请重试
                    </div>
                `).show();
            }
        });
    });
});
</script>
{% endblock %}