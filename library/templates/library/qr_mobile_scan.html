{% extends 'library/base.html' %}

{% block title %}移动端扫描 - {{ book.title }}{% endblock %}

{% block extra_head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
    .mobile-container {
        max-width: 100%;
        padding: 10px;
    }
    .mobile-card {
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-bottom: 15px;
        overflow: hidden;
    }
    .mobile-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
    }
    .mobile-body {
        padding: 20px;
    }
    .book-cover-mobile {
        width: 120px;
        height: 160px;
        object-fit: cover;
        border-radius: 8px;
        margin: 0 auto 15px;
        display: block;
    }
    .status-badge {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: bold;
        margin: 10px 0;
    }
    .status-available {
        background-color: #d4edda;
        color: #155724;
    }
    .status-borrowed {
        background-color: #fff3cd;
        color: #856404;
    }
    .action-btn {
        display: block;
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        font-weight: bold;
        margin: 10px 0;
        cursor: pointer;
        transition: all 0.3s;
    }
    .borrow-btn {
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
    }
    .return-btn {
        background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        color: white;
    }
    .info-btn {
        background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        color: white;
    }
    .qr-display {
        text-align: center;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        margin: 20px 0;
    }
    .qr-image {
        max-width: 200px;
        height: auto;
        margin: 0 auto;
    }
    .days-selector {
        display: none;
        margin: 15px 0;
    }
    .days-buttons {
        display: flex;
        justify-content: space-between;
        gap: 5px;
        margin-top: 10px;
    }
    .day-btn {
        flex: 1;
        padding: 10px;
        border: 2px solid #ddd;
        background: white;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .day-btn.active {
        border-color: #4CAF50;
        background: #4CAF50;
        color: white;
    }
    .result-message {
        display: none;
        padding: 15px;
        border-radius: 10px;
        margin: 15px 0;
        text-align: center;
    }
    .success-message {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .error-message {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
</style>
{% endblock %}

{% block content %}
<div class="mobile-container">
    <!-- 头部信息 -->
    <div class="mobile-card">
        <div class="mobile-header">
            <h2 class="mb-2">
                <i class="fas fa-qrcode"></i> 图书扫描
            </h2>
            <p class="mb-0">扫描时间: {% now "Y年m月d日 H:i" %}</p>
        </div>
        
        <div class="mobile-body">
            <!-- 图书信息 -->
            <div class="text-center mb-4">
                {% if book.cover_image %}
                    <img src="{{ book.cover_image.url }}" class="book-cover-mobile" alt="{{ book.title }}">
                {% else %}
                    <div class="book-cover-mobile bg-light d-flex align-items-center justify-content-center">
                        <i class="fas fa-book fa-3x text-muted"></i>
                    </div>
                {% endif %}
                
                <h3 class="mt-3 mb-2">{{ book.title }}</h3>
                <p class="text-muted mb-3">
                    <i class="fas fa-user-edit"></i> {{ book.author }}
                </p>
                
                <!-- 借阅状态 -->
                <div class="status-badge {% if book_copy.is_available %}status-available{% else %}status-borrowed{% endif %}">
                    {% if book_copy.is_available %}
                        <i class="fas fa-check-circle"></i> 可借阅
                    {% else %}
                        <i class="fas fa-exclamation-triangle"></i> 已借出
                    {% endif %}
                </div>
                
                {% if not book_copy.is_available %}
                    <div class="mt-3 p-3 bg-light rounded">
                        <p class="mb-1"><strong>借阅者：</strong>{{ book_copy.borrower.username }}</p>
                        <p class="mb-0"><strong>应还日期：</strong>{{ book_copy.due_date|date:"Y年m月d日" }}</p>
                    </div>
                {% endif %}
            </div>
            
            <!-- 操作按钮 -->
            <div id="actionSection">
                {% if book_copy.is_available %}
                    <!-- 借阅按钮 -->
                    <button id="borrowBtnMobile" class="action-btn borrow-btn">
                        <i class="fas fa-book-reader"></i> 借阅此书
                    </button>
                    
                    <!-- 借阅天数选择 -->
                    <div id="daysSelectorMobile" class="days-selector">
                        <label class="form-label">选择借阅天数：</label>
                        <div class="days-buttons">
                            <button class="day-btn" data-days="7">7天</button>
                            <button class="day-btn" data-days="14">14天</button>
                            <button class="day-btn" data-days="30">30天</button>
                        </div>
                        <div class="input-group mt-3">
                            <input type="number" id="customDaysMobile" class="form-control" 
                                   placeholder="自定义天数" min="1" max="90">
                            <button id="confirmBorrowMobile" class="btn btn-primary">确认</button>
                        </div>
                    </div>
                {% else %}
                    <!-- 归还按钮 -->
                    {% if user.is_authenticated and book_copy.borrower == user %}
                        <button id="returnBtnMobile" class="action-btn return-btn">
                            <i class="fas fa-undo-alt"></i> 归还此书
                        </button>
                    {% else %}
                        <div class="alert alert-info text-center">
                            <i class="fas fa-info-circle"></i>
                            此书已被其他用户借阅
                        </div>
                    {% endif %}
                {% endif %}
            </div>
            
            <!-- 操作结果 -->
            <div id="resultMessageMobile" class="result-message"></div>
            
            <!-- 二维码显示 -->
            <div class="qr-display">
                <h5><i class="fas fa-qrcode"></i> 本书二维码</h5>
                {% if book_copy.qr_code %}
                    <img src="{{ book_copy.qr_code.url }}" class="qr-image" alt="二维码">
                    <p class="text-muted mt-2 mb-0">扫描此二维码访问本书</p>
                    <p class="text-muted small">副本ID: {{ book_copy.id }}</p>
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        二维码未生成
                    </div>
                {% endif %}
            </div>
            
            <!-- 导航按钮 -->
            <div class="mt-4">
                <a href="{% url 'book_detail' book.id %}" class="action-btn info-btn">
                    <i class="fas fa-info-circle"></i> 查看详情
                </a>
                <a href="{% url 'book_list' %}" class="action-btn" style="background: #6c757d; color: white;">
                    <i class="fas fa-list"></i> 图书列表
                </a>
                {% if user.is_authenticated %}
                    <a href="{% url 'my_borrowings' %}" class="action-btn" style="background: #17a2b8; color: white;">
                        <i class="fas fa-bookmark"></i> 我的借阅
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 移动端JavaScript -->
<script>
$(document).ready(function() {
    // 借阅按钮点击
    $('#borrowBtnMobile').click(function() {
        $('#daysSelectorMobile').slideDown();
        $(this).hide();
    });
    
    // 天数选择按钮
    $('.day-btn').click(function() {
        $('.day-btn').removeClass('active');
        $(this).addClass('active');
        $('#customDaysMobile').val($(this).data('days'));
    });
    
    // 确认借阅
    $('#confirmBorrowMobile').click(function() {
        var days = $('#customDaysMobile').val();
        if (!days || days < 1) {
            showResultMessage('请输入有效的天数', 'error');
            return;
        }
        
        performAction('borrow', days);
    });
    
    // 归还按钮点击
    $('#returnBtnMobile').click(function() {
        if (confirm('确定要归还这本书吗？')) {
            performAction('return');
        }
    });
    
    // 执行操作
    function performAction(action, days = null) {
        var url = '/scan/{{ book_copy.id }}/';
        var data = {
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        };
        
        if (action === 'borrow' && days) {
            data.days = days;
        }
        
        $.ajax({
            url: url,
            type: 'POST',
            data: data,
            beforeSend: function() {
                showResultMessage('处理中...', 'info');
            },
            success: function(response) {
                if (response.success) {
                    showResultMessage(response.message, 'success');
                    // 2秒后刷新页面
                    setTimeout(function() {
                        location.reload();
                    }, 2000);
                } else {
                    if (response.redirect_url) {
                        window.location.href = response.redirect_url;
                    } else {
                        showResultMessage(response.error, 'error');
                    }
                }
            },
            error: function() {
                showResultMessage('网络请求失败，请重试', 'error');
            }
        });
    }
    
    // 显示结果消息
    function showResultMessage(message, type) {
        var resultDiv = $('#resultMessageMobile');
        var className = type === 'success' ? 'success-message' : 
                        type === 'error' ? 'error-message' : 'alert-info';
        
        resultDiv.removeClass('success-message error-message alert-info')
                 .addClass(className + ' result-message')
                 .html(`<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> ${message}`)
                 .slideDown();
    }
});
</script>
{% endblock %}