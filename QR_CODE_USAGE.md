"# 图书管理程序二维码功能使用说明\n\n## 功能概述\n\n已为图书管理程序新增二维码功能，包括：\n\n1. **每本图书副本生成唯一二维码**\n2. **扫描二维码查询借阅状态**\n3. **通过二维码借阅/归还图书**\n4. **移动端友好的扫描界面**\n5. **二维码打印功能**\n6. **管理后台二维码管理**\n\n## 安装依赖\n\n已安装的依赖：\n- `qrcode` - 二维码生成库\n- `Pillow` - 图像处理库（已安装）\n\n如果需要手动安装：\n```bash\npip install qrcode\n```\n\n## 数据库迁移\n\n由于在`BookCopy`模型中新增了`qr_code`字段，需要运行数据库迁移：\n\n```bash\ncd library\npython manage.py makemigrations\npython manage.py migrate\n```\n\n## 功能使用\n\n### 1. 生成二维码\n\n#### 方法一：管理命令\n```bash\n# 为所有图书副本生成二维码\npython manage.py generate_qr_codes\n\n# 为指定图书生成二维码\npython manage.py generate_qr_codes --book-id 1\n\n# 强制重新生成所有二维码\npython manage.py generate_qr_codes --force\n```\n\n#### 方法二：管理后台\n1. 访问Django管理后台 (`/admin/`)\n2. 进入"副本"管理页面\n3. 选择需要生成二维码的副本\n4. 使用"生成二维码"操作\n\n#### 方法三：Web界面\n1. 访问图书详情页面\n2. 点击"二维码管理"链接\n3. 在管理页面批量生成二维码\n\n### 2. 扫描二维码\n\n#### 扫描方式：\n1. **直接访问**: `/scan/<bookcopy_id>/`\n2. **移动端扫描**: 使用手机扫描图书上的二维码\n3. **API接口**: `/api/qr-info/<bookcopy_id>/` (返回JSON数据)\n\n#### 扫描后操作：\n- 如果图书可借：点击"借阅此书"按钮\n- 如果图书已借出：显示借阅者信息和应还日期\n- 如果是自己借阅的：可点击"归还此书"按钮\n\n### 3. 移动端优化\n\n系统会自动检测用户设备：\n- **移动设备**: 显示优化后的移动端界面 (`qr_mobile_scan.html`)\n- **桌面设备**: 显示标准界面 (`qr_scan.html`)\n\n### 4. 打印二维码\n\n访问打印页面：`/qr/print/<bookcopy_id>/`\n\n功能：\n- 显示适合打印的二维码标签\n- 包含图书基本信息\n- 支持批量打印\n- 打印友好的布局\n\n### 5. 管理功能\n\n#### 二维码管理页面\n访问：`/book/<book_id>/qr-management/`\n\n功能：\n- 查看所有副本的二维码状态\n- 为单个副本生成二维码\n- 批量生成所有副本的二维码\n- 下载/打印二维码\n\n#### 管理后台增强\n- 在"副本"列表显示二维码预览\n- 添加"生成二维码"批量操作\n- 显示二维码状态\n\n## 技术实现\n\n### 模型变更\n\n在`BookCopy`模型中新增：\n\n```python\nclass BookCopy(models.Model):\n    # ... 原有字段 ...\n    qr_code = models.ImageField(upload_to='qr_codes/', blank=True, null=True, verbose_name='二维码')\n    \n    def save(self, *args, **kwargs):\n        # 自动生成二维码\n        if not self.pk or not self.qr_code:\n            self.generate_qr_code()\n        super().save(*args, **kwargs)\n    \n    def generate_qr_code(self):\n        \"\"\"生成图书副本的二维码\"\"\"\n        qr_data = f\"bookcopy:{self.id}\"\n        # ... 二维码生成逻辑 ...\n```\n\n### 新增视图\n\n1. `scan_qr_code` - 二维码扫描处理\n2. `qr_code_info` - API接口\n3. `generate_qr_codes` - 批量生成二维码\n4. `qr_code_display` - 打印页面\n5. `qr_management` - 管理页面\n\n### 新增模板\n\n1. `qr_scan.html` - 标准扫描页面\n2. `qr_mobile_scan.html` - 移动端扫描页面\n3. `qr_display.html` - 打印页面\n4. `qr_management.html` - 管理页面\n\n### 新增URL路由\n\n```python\nurlpatterns = [\n    # ... 原有路由 ...\n    path('scan/<int:bookcopy_id>/', views.scan_qr_code, name='scan_qr_code'),\n    path('api/qr-info/<int:bookcopy_id>/', views.qr_code_info, name='qr_code_info'),\n    path('admin/generate-qr-codes/', views.generate_qr_codes, name='generate_qr_codes'),\n    path('qr/print/<int:bookcopy_id>/', views.qr_code_display, name='qr_code_display'),\n    path('book/<int:book_id>/qr-management/', views.qr_management, name='qr_management'),\n]\n```\n\n## 测试功能\n\n运行测试脚本检查功能完整性：\n\n```bash\ncd library\npython test_qr_functionality.py\n```\n\n## 常见问题\n\n### 1. 二维码不显示\n- 检查`qr_codes`目录权限\n- 运行`python manage.py collectstatic`\n- 检查MEDIA设置\n\n### 2. 扫描后无法操作\n- 确保用户已登录\n- 检查用户权限\n- 查看浏览器控制台错误\n\n### 3. 移动端显示异常\n- 检查设备检测逻辑\n- 测试不同移动设备\n- 检查CSS响应式布局\n\n### 4. 打印问题\n- 使用Chrome浏览器打印\n- 检查打印预览\n- 调整打印CSS\n\n## 后续优化建议\n\n1. **批量打印**: 支持一次打印多个图书二维码\n2. **二维码美化**: 添加Logo、颜色定制\n3. **扫描统计**: 记录二维码扫描次数\n4. **离线功能**: PWA支持离线扫描\n5. **微信集成**: 微信小程序扫描支持\n\n## 联系支持\n\n如有问题，请检查：\n1. Django错误日志\n2. 浏览器开发者工具\n3. 数据库迁移状态\n4. 文件权限设置"